import sys
import urllib2
import json
import re

usernames='xxx'
passwords='xxx'

print '\n < IP user findout tool > version 0.11 by VesonQI'

imc_url='x.x.x.x'
http_url='https://'
api_url_ip='/imcrs/uam/online/onlineNotice?framedIp='
api_url_mac='/imcrs/uam/online/onlineNotice?macAddress='
inputstr=raw_input('\ninput ip or mac address:')
api_url_history='/imcrs/uam/acmUser/acmDetailList?size=5&framedIpAddressFrom='+inputstr+'&framedIpAddressTo='+inputstr+'&desc=true'
print '\n  Your Input is  :'+inputstr+'\n'

def isValidIP(str):
    if re.match(r"\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b", str):
        return True
    else:
        return False

def isValidMAC(str):
    if re.match(r"^\s*([0-9a-fA-F]{2,2}:){5,5}[0-9a-fA-F]{2,2}\s*$",str):
        return True
    else:
        return False

def isValidIPorMAC(str):
    if isValidIP(str):
        return True
    else:
        if isValidMAC(str):
            return True
        else:
            return False

if isValidIPorMAC(inputstr):
    if isValidIP(inputstr):
        find_api=http_url+imc_url+api_url_ip+inputstr
    else:
        find_api=http_url+imc_url+api_url_mac+inputstr
        api_url_history='/imcrs/uam/acmUser/acmDetailList?size=5&macAddress'+inputstr+'&desc=true'
    try:
        authhandler = urllib2.HTTPDigestAuthHandler()
        authhandler.add_password("iMC RESTful Web Services", imc_url, usernames, passwords)
        opener = urllib2.build_opener(authhandler)
        urllib2.install_opener(opener)
        pagehandle=urllib2.Request(find_api)
        pagehandle.add_header('Accept', 'application/json')

        result = urllib2.urlopen(pagehandle)
        findout=json.loads(result.read()).values()

    except ValueError:
        print '  Notice:the input address is NOT online now !'

    else:
        userip=findout[0]['framedIp']
        starttime=findout[0]['beginTime']
        frontstr=findout[0]['userName']
        usermac=findout[0]['macAddress']
        userfullname=findout[0]['fullName']

        print '  Find 1 Online Record:'+'\n'

        print '    UserIP/MAC:'+userip+' / '+usermac
        print '    UserName  :'+frontstr+' / '+userfullname
        print '    StartTime :'+starttime

    try:
        find_api=http_url+imc_url+api_url_history
        pagehandle=urllib2.Request(find_api)
        pagehandle.add_header('Accept', 'application/json')

        result = urllib2.urlopen(pagehandle)
        findout=json.loads(result.read())
    except ValueError:
        print '  Notice:the input address has NO online record !'
    else:
        try:
            number=len(findout['acmDetail'])
            number_list=min(len(findout['acmDetail']),5)
        except KeyError:
        	print '\n  Notice:the input address has NO online record !'
        else:
            print '\n  Find latest '+str(number)+' Result(s),'+ str(number_list) +' Record(s) listed below:\n'

            for seq in range(0,number_list):
                findout_history=findout['acmDetail'][seq]
                userip=findout_history['framedIpAddress']
                starttime=findout_history['accessStartTime']
                endtime=findout_history['accessEndTime']
                frontstr=findout_history['userName']
                usermac=findout_history['macAddress']
                userfullname=findout_history['fullName']
                print '    OnlineTime:'+starttime+' - '+endtime
                print '    UserIP/MAC:'+userip+' / '+usermac
                print '    UserName  :'+frontstr+' / '+userfullname+'\n'

else:
    print '  Notice:input string is NOT a valid ip or MAC address !'
